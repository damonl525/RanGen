{# Jinja2 Template: Drug Randomization Driver #}
/* ========================================================================= */
/* SAS Randomization Code Generator - Drug Randomization */
/* Generated by Logic-Driven Template Engine */
/* ========================================================================= */

/* 1. Generate Drug Blind List (Randomization) */

{% set drc = study.drug_randomization_config %}
{% if drc and drc.enabled %}

{# Prepare parameters for m_rand #}
{% set armcds = drc.drug_arms | map(attribute='code') | join('|') %}
{% set arms = drc.drug_arms | map(attribute='name') | join('|') %}

{# Prepare Stratification Params #}
{% set strata_list = [] %}
{% for f in drc.stratification_factors %}
    {% for l in f.levels %}
        {% do strata_list.append(l) %}
    {% endfor %}
{% endfor %}
{% set strata_param = strata_list | join('|') %}

%m_rand(
    Strata={{ strata_param }},
    Block={{ drc.block_layers }},
    Rand={{ drc.block_size }},
    out=rand_drug_1,
    startNo={{ ("%0" ~ drc.number_length ~ "d") | format(drc.start_number) if drc.number_prefix else drc.start_number }},
    Prefix={{ drc.number_prefix }},
    armcd={{ armcds }},
    Arm={{ arms }},
    seed=&drugseed,
    num_gap={{ drc.num_gap }},
    protocol={{ study.main_study_name }}
);

/* 2. Post Processing (Sizes and Labels) */
data drug_processed_1;
    length drugsize drugcds $100;
    set rand_drug_1;
    
    /* Drug Specifications Logic */
    {% for arm in drc.drug_arms %}
        /* Arm: {{ arm.code }} */
        if armcd="{{ arm.code }}" and upcase(Strata) not in ("批次" "批号" "BATCH") then do; 
            drugsize="{{ arm.name }} {{ arm.drug_spec }}"||strip(Strata); 
            drugcds=strip(armcd); 
        end;
        else if armcd="{{ arm.code }}" then do; 
            drugsize="{{ arm.name }} {{ arm.drug_spec }}"; 
            drugcds=strip(armcd); 
        end;
    {% endfor %}
    
    seq=_n_;
    rename armcd=drugcd arm=drug subjno=drugno;
run;

/* 3. Export to CSV using m_rpe_drug */
{# Calculate batch params needed for m_rpe_drug #}
{% set batch_params = namespace(batch_num=0, batch1_end=0, has_batch='N') %}

{% if drc.independent_batch_settings %}
     {% set batch_params.has_batch = 'Y' %}
     {% for k, v in drc.independent_batch_settings.items() %}
         {% if loop.first %}
             {% set batch_params.batch_num = v | length %}
             {% if batch_params.batch_num >= 1 %}
                 {% set qty = v[0].quantity %}
                 {% if qty == 'auto' %}{% set qty = 0 %}{% endif %}
                 {% set batch_params.batch1_end = qty %}
             {% endif %}
         {% endif %}
     {% endfor %}
{% elif drc.stratification_factors %}
     {% for f in drc.stratification_factors %}
         {% if f.batch_enabled %}
              {% set batch_params.has_batch = 'Y' %}
              {% for k, v in f.batch_settings.levels.items() %}
                  {% if loop.first %}
                      {% set batch_params.batch_num = v | length %}
                      {% if batch_params.batch_num >= 1 %}
                         {% set qty = v[0].quantity %}
                         {% if qty == 'auto' %}{% set qty = 0 %}{% endif %}
                         {% set batch_params.batch1_end = qty %}
                      {% endif %}
                  {% endif %}
              {% endfor %}
         {% endif %}
     {% endfor %}
{% endif %}

%m_rpe_drug(
    ds=drug_processed_1,
    startNo={{ ("%0" ~ drc.number_length ~ "d") | format(drc.start_number) if drc.number_prefix else drc.start_number }}, 
    Prefix={{ drc.number_prefix }},
    num_gap={{ drc.num_gap }},
    secRand={{ 'Y' if drc.sec_rand_enabled else 'N' }},
    seed=&drugseed,
    batch_num={{ batch_params.batch_num }},
    batch1_end={{ batch_params.batch1_end }},
    has_batch={{ batch_params.has_batch }},
    supplier={{ study.output_settings.supplier }}
);

/* 4. Consolidation */
data Output.drug;
    set drug_processed_1;
    /* Consolidate Seq? */
    seq = _n_;
run;

{% endif %}

/* 5. Final Reporting (Consolidated) */
/* Requires a generic m_rpt_drug that can handle the combined dataset */
{% set method_parts_drug = [] %}
{% if study.drug_randomization_config and study.drug_randomization_config.stratification_factors %}
    {% do method_parts_drug.append('分层') %}
{% endif %}
{% do method_parts_drug.append('区组随机') %}
{% set combined_method_drug = method_parts_drug | join('') %}

%m_rpt_drug(
    ds=Output.drug,
    drug=drug, 
    drugby=drugcd, 
    drugno=drugno, 
    method=%str({{ combined_method_drug }}), 
    units={{ study.cohorts[0].config.report_units if study.cohorts else '盒' }}
);

/* 6. Check Balance */
proc freq data=Output.drug;
    tables drugcd;
    title "Check Balance for Drug Randomization";
run;

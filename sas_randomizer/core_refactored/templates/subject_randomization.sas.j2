{# Jinja2 Template: Subject Randomization Driver #}
/* ========================================================================= */
/* SAS Randomization Code Generator - Subject Randomization */
/* Generated by Logic-Driven Template Engine */
/* ========================================================================= */

/* 1. 主随机化：生成受试者随机列表 */

{# Prepare Arms #}
{% set arms_list = [] %}
{% set armcds_list = [] %}
{% for arm in study.treatment_arms %}
    {# 按照比例重复添加 #}
    {% for i in range(arm.ratio | int) %}
        {% do arms_list.append(arm.name) %}
        {% do armcds_list.append(arm.armcd) %}
    {% endfor %}
{% endfor %}
{% set arm_param = arms_list | join('|') %}
{% set armcd_param = armcds_list | join('|') %}

{# Prepare Strata #}
{% set strata_list = [] %}
{% for factor in study.stratification_factors %}
    {% for level in study.strata_levels[factor] %}
        {% do strata_list.append(level) %}
    {% endfor %}
{% endfor %}
{% set strata_param = strata_list | join('|') %}

{# Block Logic #}
{% if study.variable_block_enabled %}
    {% set var_block_flag = 'Y' %}
    {% set var_block_sizes = study.variable_block_sizes | join('|') %}
{% else %}
    {% set var_block_flag = 'N' %}
    {% set var_block_sizes = '' %}
{% endif %}

{% if study.multi_protocol %}
    /* 多子方案循环 */
    {% for proto in study.protocols %}
        %m_rand(
            Strata={{ strata_param }},
            Block={{ study.blocks_per_stratum }},
            Rand={{ study.block_size }},
            out=rand0{{ loop.index }},
            startNo={{ study.start_subject_number | string | replace(' ', '') }},
            Prefix={{ study.subject_number_prefix }},
            armcd={{ armcd_param }},
            Arm={{ arm_param }},
            seed=&subjseed,
            protocol={{ proto.name }},
            VarBlock={{ var_block_flag }},
            VarBlockSizes={{ var_block_sizes }},
            TotalN={{ study.total_sample_size }},
            num_gap={{ study.num_gap }}
        );
    {% endfor %}
    
    /* 合并子方案数据 */
    data rand01;
        set 
        {% for proto in study.protocols %} rand0{{ loop.index }} {% endfor %}
        ;
    run;
    
{% else %}
    /* 单一研究 */
    %m_rand(
        Strata={{ strata_param }},
        Block={{ study.blocks_per_stratum }},
        Rand={{ study.block_size }},
        out=rand01,
        startNo={{ ("%04d" | format(study.start_subject_number)) if study.subject_number_length == 4 else study.start_subject_number }},
        Prefix={{ study.subject_number_prefix }},
        armcd={{ armcd_param }},
        Arm={{ arm_param }},
        seed=&subjseed,
        protocol={{ study.main_study_name }},
        VarBlock={{ var_block_flag }},
        VarBlockSizes={{ var_block_sizes }},
        TotalN={{ study.total_sample_size }},
        num_gap={{ study.num_gap }}
    );
{% endif %}

/* 2. 数据后处理 */
data output.rand;
    set rand01;
    by protocol subjno;

    /* 确保所有必要变量都存在 */
    category="正式号";
    catord=1;
    {% if not study.multi_protocol %}
    protocol = '主方案';
    {% endif %}
    seq=_n_;
    Subsnumber = '';
    group=armcd;
    dose='1';

    {% if study.mirror_replacement %}
        /* 镜像号/替换号逻辑 (如果启用) */
        /* TODO: Implement Mirror/Replacement Logic if needed here */
    {% endif %}

    {% if study.multi_protocol %}
        /* 多子方案排序标记 */
        {% for proto in study.protocols %}
            if protocol = "{{ proto.name }}" then protocol_order = {{ loop.index }};
        {% endfor %}
    {% else %}
            /* 单子方案情况 */
            protocol_order = 1;
            if missing(protocol) then protocol = "主方案";
    {% endif %}

    /* 确保pg变量存在 */
    if missing(pg) then pg = 1;

    /* 确保StrataN变量存在 */
    if missing(Strata) then do;StrataN=1;end;

    /* 确保有分层的情况下，区组号是唯一的 */
	if StrataN>1 then bn=bn+(StrataN-1)*{{ study.mirror_gap }};
run;

{% if study.mirror_replacement %}
    /* 生成镜像替换号数据 */
    data mirror_replacement;
        set output.rand;
        /* 镜像替换号：在正式号基础上添加S后缀 */
        SubjNo = cats(SubjNo, 'S');
        category = "替换号";
        catord=2;
        /* 替换号的区组号 = 正式号的区组号 + {{ study.mirror_gap }} */
        bn = bn + {{ study.mirror_gap }};
        /* 保持相同的替换序号，实现配对关系 */
    run;

    /* 合并正式号和镜像替换号 */
    data output.rand;
        set output.rand mirror_replacement;
    run;
{% endif %}

/* 3. 调用动态排序宏并执行排序 - 确保报告和CSV使用一致的排序 */
proc sort data=output.rand;
    by protocol_order protocol StrataN Strata catord category SubjNo;
run;

/* 4. 生成报告和CSV */
{% set method_parts = [] %}
{% if study.stratification_factors %}
    {% do method_parts.append('分层') %}
{% endif %}
{% if study.variable_block_enabled %}
    {% do method_parts.append('可变') %}
{% endif %}
{% do method_parts.append('区组随机') %}
{% set combined_method = method_parts | join('') %}

%m_rpt(ds=output.rand, method=%str({{ combined_method }}));
%m_rpe(inds=output.rand, supplier={{ study.supplier }});

/* 5. 检查平衡性 */
proc freq data=output.rand;
    tables Strata * Arm / nopercent nocol norow;
    title "Check Balance for Subject Randomization";
run;
